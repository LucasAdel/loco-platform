#!/bin/bash
# Pre-commit hook for Rust projects

set -e

echo "ğŸ” Running pre-commit checks..."

# Check if we're in a git repository
if ! git rev-parse --git-dir > /dev/null 2>&1; then
    echo "âŒ Not in a git repository"
    exit 1
fi

# Get the list of staged Rust files
STAGED_RUST_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep '\.rs$' || true)

if [ -z "$STAGED_RUST_FILES" ]; then
    echo "â„¹ï¸  No Rust files staged, skipping Rust checks"
else
    echo "ğŸ¦€ Running Rust checks..."
    
    # Format check
    echo "  ğŸ“ Checking formatting..."
    if ! cargo fmt --all -- --check; then
        echo "âŒ Formatting issues found. Run 'cargo fmt --all' to fix."
        exit 1
    fi
    
    # Syntax check
    echo "  âœ“ Checking syntax..."
    if ! cargo check --all; then
        echo "âŒ Syntax errors found."
        exit 1
    fi
    
    # Clippy lints
    echo "  ğŸ“ Running clippy..."
    if ! cargo clippy --all-targets -- -D warnings; then
        echo "âŒ Clippy warnings found."
        exit 1
    fi
fi

# Check for large files
echo "ğŸ“¦ Checking file sizes..."
MAX_SIZE=1048576  # 1MB in bytes
for file in $(git diff --cached --name-only); do
    if [ -f "$file" ]; then
        size=$(wc -c < "$file")
        if [ "$size" -gt "$MAX_SIZE" ]; then
            echo "âŒ File $file is too large ($(($size / 1024))KB > 1MB)"
            exit 1
        fi
    fi
done

# Check for merge conflicts
echo "ğŸ”€ Checking for merge conflicts..."
if git diff --cached --name-only | xargs grep -l '<<<<<<< HEAD' 2>/dev/null; then
    echo "âŒ Merge conflict markers found"
    exit 1
fi

# Check TOML files
STAGED_TOML_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep '\.toml$' || true)
if [ -n "$STAGED_TOML_FILES" ]; then
    echo "ğŸ“‹ Validating TOML files..."
    for file in $STAGED_TOML_FILES; do
        if ! python3 -c "import toml; toml.load('$file')" 2>/dev/null; then
            echo "âŒ Invalid TOML file: $file"
            exit 1
        fi
    done
fi

echo "âœ… All pre-commit checks passed!"